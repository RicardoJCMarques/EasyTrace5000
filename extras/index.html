<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clipper2 WASM Test Suite</title>
    <link rel="stylesheet" href="clipper2testpage.css">
</head>
<body>
    <div class="container">
        <h1>
            Clipper2 WASM Test Suite
            <span class="version-badge">v5.2</span>
        </h1>

        <!-- Core Boolean Operations -->
        <h2 class="test-group-header">Core Boolean Operations</h2>
        
        <div class="test-grid">
            <!-- Boolean Operations Test -->
            <div class="test-card" data-test="boolean">
                <div class="test-header">
                    <h3 class="test-title">Boolean Operations</h3>
                </div>
                <p class="test-description">Test union, intersection, difference, and XOR operations with draggable shapes</p>
                
                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <canvas id="boolean-canvas" width="400" height="400"></canvas>
                        <span id="boolean-label" class="canvas-label">Input Geometry</span>
                    </div>
                </div>
                
                <div class="controls">
                    <div class="control">
                        <label for="boolean-operation">Operation:</label>
                        <select id="boolean-operation">
                            <option value="union">Union</option>
                            <option value="intersection">Intersection</option>
                            <option value="difference">Difference</option>
                            <option value="xor">XOR</option>
                        </select>
                    </div>
                    <div class="control">
                        <label for="boolean-clip-shape">Clip Shape:</label>
                        <select id="boolean-clip-shape">
                            <option value="circle">Circle</option>
                            <option value="triangle">Triangle</option>
                            <option value="square">Square</option>
                            <option value="star">Star</option>
                            <option value="random">Random</option>
                            <option value="rabbit">Rabbit (SVG)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="tests.testBooleanOperation()">Run Operation</button>
                    <button class="btn btn-secondary" onclick="tests.resetTest('boolean')">Reset</button>
                    <button class="btn btn-success" onclick="tests.exportSVG('boolean')">Export SVG</button>
                </div>
                
                <div id="boolean-result" class="result">Ready to run test</div>
                <div id="boolean-info" class="geometry-info"></div>
            </div>

            <!-- Letter B Test -->
            <div class="test-card" data-test="letter-b">
                <div class="test-header">
                    <h3 class="test-title">Letter B Creation<span class="badge">Hole Detection</span></h3>
                </div>
                <p class="test-description">Union strokes to form the letter B with proper CCW holes</p>
                
                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <canvas id="letter-b-canvas" width="400" height="400"></canvas>
                        <span id="letter-b-label" class="canvas-label">Input Strokes</span>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="tests.testLetterB()">Create Letter B</button>
                    <button class="btn btn-secondary" onclick="tests.resetTest('letter-b')">Reset</button>
                    <button class="btn btn-success" onclick="tests.exportSVG('letter-b')">Export SVG</button>
                </div>
                
                <div id="letter-b-result" class="result">Ready to run test</div>
                <div id="letter-b-info" class="geometry-info"></div>
            </div>

            <!-- Nested Structure Test -->
            <div class="test-card" data-test="nested">
                <div class="test-header">
                    <h3 class="test-title">Nested Structure</h3>
                </div>
                <p class="test-description">Create complex nested shapes with draggable islands</p>
                
                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <canvas id="nested-canvas" width="400" height="400"></canvas>
                        <span id="nested-label" class="canvas-label">Input Geometry</span>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="tests.testNestedStructure()">Create Structure</button>
                    <button class="btn btn-secondary" onclick="tests.resetTest('nested')">Reset</button>
                    <button class="btn btn-success" onclick="tests.exportSVG('nested')">Export SVG</button>
                </div>
                
                <div id="nested-result" class="result">Ready to run test</div>
                <div id="nested-info" class="geometry-info"></div>
            </div>

            <!-- PCB Trace Fusion Test -->
            <div class="test-card" data-test="pcb-fusion">
                <div class="test-header">
                    <h3 class="test-title">PCB Trace Fusion</h3>
                </div>
                <p class="test-description">Merge PCB traces and pads into unified regions with holes</p>
                
                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <canvas id="pcb-fusion-canvas" width="400" height="400"></canvas>
                        <span id="pcb-fusion-label" class="canvas-label">PCB Components</span>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="tests.testPCBFusion()">Fuse Components</button>
                    <button class="btn btn-secondary" onclick="tests.resetTest('pcb-fusion')">Reset</button>
                    <button class="btn btn-success" onclick="tests.exportSVG('pcb-fusion')">Export SVG</button>
                </div>
                
                <div id="pcb-fusion-result" class="result">Ready to run test</div>
                <div id="pcb-fusion-info" class="geometry-info"></div>
            </div>
        </div>

        <!-- Path Operations -->
        <h2 class="test-group-header">Path Operations</h2>
        
        <div class="test-grid">
            <!-- Offset Test -->
            <div class="test-card" data-test="offset">
                <div class="test-header">
                    <h3 class="test-title">Path Offsetting</h3>
                </div>
                <p class="test-description">Create internal and external offsets with various join types</p>
                
                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <canvas id="offset-canvas" width="400" height="400"></canvas>
                        <span id="offset-label" class="canvas-label">Base Shape</span>
                    </div>
                </div>
                
                <div class="controls">
                    <div class="control">
                        <label for="offset-shape">Shape:</label>
                        <select id="offset-shape">
                            <option value="star">Star</option>
                            <option value="circle">Circle</option>
                            <option value="square">Square</option>
                            <option value="triangle">Triangle</option>
                            <option value="bottleneck">Bottleneck</option>
                        </select>
                    </div>
                    <div class="control">
                        <label for="offset-type">Type:</label>
                        <select id="offset-type">
                            <option value="external">External</option>
                            <option value="internal">Internal</option>
                        </select>
                    </div>
                    <div class="control">
                        <label for="offset-count">Count:</label>
                        <input type="number" id="offset-count" value="3" min="1" max="10">
                    </div>
                    <div class="control">
                        <label for="offset-distance">Distance:</label>
                        <input type="number" id="offset-distance" value="10" min="1" max="50">
                    </div>
                    <div class="control">
                        <label for="offset-join">Join Type:</label>
                        <select id="offset-join">
                            <option value="Round">Round</option>
                            <option value="Miter">Miter</option>
                            <option value="Square">Square</option>
                        </select>
                    </div>
                    <div class="control">
                        <label for="offset-miter-limit">Miter Limit:</label>
                        <input type="number" id="offset-miter-limit" value="10" min="1" max="20" step="0.5">
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="tests.testOffset()">Apply Offset</button>
                    <button class="btn btn-secondary" onclick="tests.resetTest('offset')">Reset</button>
                    <button class="btn btn-success" onclick="tests.exportSVG('offset')">Export SVG</button>
                </div>
                
                <div id="offset-result" class="result">Ready to run test</div>
                <div id="offset-info" class="geometry-info"></div>
            </div>

            <!-- Simplify Test -->
            <div class="test-card" data-test="simplify">
                <div class="test-header">
                    <h3 class="test-title">Path Simplification</h3>
                </div>
                <p class="test-description">Reduce vertices while preserving shape (using rabbit SVG)</p>
                
                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <canvas id="simplify-canvas" width="400" height="400"></canvas>
                        <span id="simplify-label" class="canvas-label">Original Path</span>
                    </div>
                </div>
                
                <div class="controls">
                    <div class="control">
                        <label for="simplify-tolerance">Tolerance:</label>
                        <input type="number" id="simplify-tolerance" min="0.5" max="50" value="2" step="0.5">
                    </div>
                    <button class="btn btn-primary" onclick="tests.testSimplify()">Simplify Path</button>
                    <button class="btn btn-secondary" onclick="tests.resetTest('simplify')">Reset</button>
                    <button class="btn btn-success" onclick="tests.exportSVG('simplify')">Export SVG</button>
                </div>
                
                <div id="simplify-result" class="result">Ready to run test</div>
                <div id="simplify-info" class="geometry-info"></div>
            </div>

            <!-- Minkowski Operations Test -->
            <div class="test-card" data-test="minkowski">
                <div class="test-header">
                    <h3 class="test-title">Minkowski vs Offset<span class="badge new">Comparison</span></h3>
                </div>
                <p class="test-description">Compare Minkowski operations with standard offsets. Circle patterns produce identical results, while non-circular patterns reveal key differences in corner handling and sweep behavior.</p>
                
                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <canvas id="minkowski-canvas" width="400" height="400"></canvas>
                        <span id="minkowski-label" class="canvas-label">Minkowski Result</span>
                    </div>
                </div>
                
                <div class="controls">
                    <div class="control">
                        <label for="minkowski-pattern">Pattern:</label>
                        <select id="minkowski-pattern">
                            <option value="circle">Circle (≡ offset)</option>
                            <option value="square">Square</option>
                            <option value="triangle">Triangle</option>
                            <option value="star">Star</option>
                            <option value="diamond">Diamond</option>
                            <option value="hex">Hexagon</option>
                        </select>
                    </div>
                    <div class="control">
                        <label for="minkowski-path">Path:</label>
                        <select id="minkowski-path">
                            <option value="line">Line</option>
                            <option value="triangle">Triangle</option>
                            <option value="square">Square</option>
                            <option value="concave">Concave Shape</option>
                            <option value="zigzag">Zigzag</option>
                            <option value="lshape">L-Shape</option>
                        </select>
                    </div>
                    <div class="control">
                        <label for="minkowski-operation">Operation:</label>
                        <select id="minkowski-operation">
                            <option value="sum">Sum (≈ external offset)</option>
                            <option value="diff">Difference (≈ internal offset)</option>
                        </select>
                    </div>
                </div>
                
                <div class="controls">
                    <div class="control">
                        <label for="minkowski-sweep">
                            <input type="checkbox" id="minkowski-sweep">
                            Show Sweep
                        </label>
                    </div>
                    <div class="control">
                        <label for="minkowski-offset">
                            <input type="checkbox" id="minkowski-offset">
                            Compare with Offset
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="tests.testMinkowski()">Calculate</button>
                    <button class="btn btn-secondary" onclick="tests.resetTest('minkowski')">Reset</button>
                    <button class="btn btn-success" onclick="tests.exportSVG('minkowski')">Export SVG</button>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(16, 185, 129, 0.3); border-color: #10b981;"></div>
                        <span>Minkowski Result</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: none; border: 2px dashed #f59e0b;"></div>
                        <span>Offset Result</span>
                    </div>
                </div>
                
                <div id="minkowski-result" class="result">Ready to run test</div>
                <div id="minkowski-info" class="geometry-info"></div>
            </div>
        </div>

        <!-- Analysis Tools -->
        <h2 class="test-group-header">Analysis Tools</h2>
        
        <div class="test-grid">
            <!-- Point in Polygon Test -->
            <div class="test-card" data-test="pip">
                <div class="test-header">
                    <h3 class="test-title">Point in Polygon</h3>
                </div>
                <p class="test-description">Test if points are inside, outside, or on polygon edges</p>
                
                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <canvas id="pip-canvas" width="400" height="400"></canvas>
                        <span id="pip-label" class="canvas-label">Test Polygon</span>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="tests.checkPointLocations()">Check Locations</button>
                    <button class="btn btn-secondary" onclick="tests.resetTest('pip')">Reset</button>
                </div>
                <div class="control">
                    <label for="pip-tolerance">Edge Tolerance:</label>
                    <input type="number" id="pip-tolerance" value="3" min="1" max="20" step="0.5">
                    <span>px</span>
                </div>
                
                <div id="pip-result" class="result">Click to add test points</div>
                <div id="pip-info" class="geometry-info"></div>
            </div>

            <!-- Area Test -->
            <div class="test-card" data-test="area">
                <div class="test-header">
                    <h3 class="test-title">Area Calculation</h3>
                </div>
                <p class="test-description">Draw a polygon and calculate its area and winding direction</p>
                
                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <canvas id="area-canvas" width="400" height="400"></canvas>
                        <span id="area-label" class="canvas-label">Draw Polygon</span>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="tests.calculateArea()">Calculate Area</button>
                    <button class="btn btn-secondary" onclick="tests.resetTest('area')">Reset</button>
                </div>
                
                <div id="area-result" class="result">Click points to draw polygon (min 3)</div>
                <div id="area-info" class="geometry-info"></div>
            </div>
        </div>

        <!-- Additional Information -->
        <div style="margin-top: 3rem; padding: 2rem; background: var(--surface); border-radius: 8px;">
            <h3 style="color: var(--primary); margin-bottom: 1rem;">Additional Clipper2 Functions</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                The Clipper2 WASM wrapper also provides access to these functions not demonstrated in the tests above:
            </p>
            <ul style="color: var(--text); line-height: 1.8;">
                <li><strong>PolyTree/PolyPath structures:</strong> Hierarchical polygon representation with parent-child relationships, useful for complex nested geometries</li>
                <li><strong>TrimCollinear:</strong> Removes redundant vertices on straight segments to optimize path definitions</li>
                <li><strong>Z-coordinate callbacks:</strong> Allows custom metadata interpolation during clipping operations when new vertices are created at intersections</li>
                <li><strong>RectClip operations:</strong> Extremely fast O(n) rectangular clipping for axis-aligned regions (viewport culling, etc.)</li>
            </ul>
            <p style="color: var(--text-secondary); margin-top: 1rem;">
                These functions are available through the Clipper2 wrapper but require direct API usage. See the 
                <a href="https://github.com/ErikSom/Clipper2-WASM/" style="color: var(--primary);">documentation</a> 
                for implementation details.
            </p>
        </div>
    </div>

    <!-- Loading indicator -->
    <div id="loading" class="loading active">
        <div class="spinner"></div>
    </div>

    <!-- Scripts -->
    <script src="clipper2z.js"></script>
    <script src="clipper2z-utils.js"></script>
    <script src="clipper2-defaults.js"></script>
    <script src="clipper2-core.js"></script>
    <script src="clipper2-geometry.js"></script>
    <script src="clipper2-operations.js"></script>
    <script src="clipper2-rendering.js"></script>
    <script src="clipper2-tests.js"></script>
    <script src="clipper2-ui.js"></script>
    <script>
        // Global test instance
        let tests = null;
        let ui = null;

        // Initialize on page load
        async function initializeApp() {
            try {
                // Create test system
                tests = new Clipper2Tests();
                await tests.initialize();
                
                // Initialize operations and geometry with defaults
                tests.operations.initialize(Clipper2Defaults);
                tests.geometry.initialize(Clipper2Defaults);
                tests.rendering.initialize(Clipper2Defaults);
                
                // Create and initialize UI
                ui = new Clipper2UI(tests);
                await ui.initialize();
                
                console.log('[APP] Initialization complete');
                
            } catch (error) {
                console.error('[APP] Failed to initialize:', error);
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.innerHTML = `
                        <div style="color: #ef4444; text-align: center; padding: 2rem;">
                            <h2>⚠️ Initialization Error</h2>
                            <p>${error.message}</p>
                            <button onclick="location.reload()" class="btn btn-primary">
                                Reload Page
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>