/**
 * @file        export/processors/grbl-processor.js
 * @description GRBL post-processing module
 * @author      Eltryus - Ricardo Marques
 * @see         {@link https://github.com/RicardoJCMarques/EasyTrace5000}
 * @license     AGPL-3.0-or-later
 */

/*
 * EasyTrace5000 - Advanced PCB Isolation CAM Workspace
 * Copyright (C) 2025 Eltryus
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

(function() {
    'use strict';
    
    class GRBLPostProcessor extends BasePostProcessor {
        constructor() {
            super('GRBL', {
                fileExtension: '.nc',
                supportsToolChange: false,
                supportsArcCommands: true,
                supportsCannedCycles: false,
                arcFormat: 'IJ',
                coordinatePrecision: 3,
                feedPrecision: 0,
                spindlePrecision: 0,
                modalCommands: true,
                maxSpindleSpeed: 30000,
                maxRapidRate: 1000
            });
        }
        
        generateHeader(options) {
            const lines = [];
            
            lines.push('(Generated by EasyTrace5000)');
            lines.push(`(Date: ${new Date().toISOString()})`);
            lines.push('(Post-processor: GRBL)');
            lines.push('');
            
            // Initialization
            lines.push('G90 (Absolute positioning)');
            lines.push('G21 (Metric units)');
            lines.push('G17 (XY plane)');
            lines.push('G94 (Units per minute feed mode)');
            lines.push('G54 (Work coordinate system)');
            lines.push('');
            
            // Spindle start
            const spindleSpeed = options.spindleSpeed || 12000;
            lines.push(`M3 S${this.formatSpindle(spindleSpeed)} (Start spindle)`);
            lines.push('G4 P1 (Dwell 1 second)');
            lines.push('');
            
            // Move to safe position
            const safeZ = options.safeZ || this.config.safetyHeight;
            lines.push(`G0 Z${this.formatCoordinate(safeZ)} (Move to safe Z)`);
            lines.push('G0 X0 Y0 (Move to origin)');
            lines.push('');
            
            return lines.join('\n');
        }
        
        generateFooter(options) {
            const lines = [];
            const safeZ = options.safeZ || this.config.safetyHeight;
            
            lines.push('');
            lines.push('M5 (Stop spindle)');
            lines.push(`G0 Z${this.formatCoordinate(safeZ)} (Retract to safe Z)`);
            lines.push('G0 X0 Y0 (Return to origin)');
            lines.push('M2 (Program end)');
            lines.push('');
            lines.push('(End of program)');
            
            return lines.join('\n');
        }
        
        generateToolChange(tool, options) {
            const lines = [];
            const safeZ = options.safeZ || this.config.safetyHeight;
            
            lines.push('');
            lines.push(`(Tool change: ${tool.name || tool.id})`);
            lines.push(`(Diameter: ${tool.diameter}mm)`);
            lines.push('M5 (Stop spindle)');
            lines.push(`G0 Z${this.formatCoordinate(safeZ)} (Retract to safe Z)`);
            this.currentPosition.z = safeZ;
            lines.push('M0 (Pause for manual tool change)');
            lines.push('');
            
            const spindleSpeed = tool.spindleSpeed || options.spindleSpeed || 12000;
            lines.push(`M3 S${this.formatSpindle(spindleSpeed)} (Restart spindle)`);
            lines.push('G4 P1 (Wait for spindle)');
            lines.push('');
            
            return lines.join('\n');
        }
        
        // GRBL-specific: validate command safety
        validateCommand(cmd) {
            const warnings = [];
            
            // Check spindle speed limits
            if (cmd.type === 'SPINDLE' && cmd.speed > this.config.maxSpindleSpeed) {
                warnings.push(`Spindle speed ${cmd.speed} exceeds maximum ${this.config.maxSpindleSpeed}`);
            }
            
            // Check for unsupported features
            if (cmd.type && cmd.type.includes('CANNED')) {
                warnings.push('Canned cycles not supported by GRBL - will be expanded');
            }
            
            return warnings;
        }
    }
    
    window.GRBLPostProcessor = GRBLPostProcessor;
})();