/**
 * @file        export/processors/marlin-processor.js
 * @description Marlin post-processing module for 3D printer-based CNCs
 * @author      Eltryus - Ricardo Marques
 * @see         {@link https://github.com/RicardoJCMarques/EasyTrace5000}
 * @license     AGPL-3.0-or-later
 */

/*
 * EasyTrace5000 - Advanced PCB Isolation CAM Workspace
 * Copyright (C) 2025 Eltryus
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

(function() {
    'use strict';
    
    class MarlinPostProcessor extends BasePostProcessor {
        constructor() {
            super('Marlin', {
                fileExtension: '.gcode',
                supportsToolChange: false,
                supportsArcCommands: true,
                supportsCannedCycles: false,
                arcFormat: 'IJ',
                coordinatePrecision: 3,
                feedPrecision: 0,
                spindlePrecision: 0,
                modalCommands: true,
                maxSpindleSpeed: 255, // PWM range
                maxRapidRate: 1000
            });
        }
        
        generateHeader(options) {
            const lines = [];
            
            lines.push('; Generated by EasyTrace5000');
            lines.push(`; Date: ${new Date().toISOString()}`);
            lines.push('; Post-processor: Marlin (RepRap firmware)');
            lines.push(';');
            
            // Initialization
            lines.push('G90 ; Absolute positioning');
            lines.push('G21 ; Metric units');
            lines.push('G17 ; XY plane');
            lines.push('G94 ; Units per minute feed mode');
            lines.push('M82 ; Absolute extrusion mode');
            lines.push('');
            
            // Spindle/Fan start - scale RPM to PWM (0-255)
            const spindleSpeed = options.spindleSpeed || 12000;
            const pwmValue = Math.min(255, Math.round((spindleSpeed / 30000) * 255));
            
            if (options.useM3) {
                // Some Marlin configs support M3 for spindle
                lines.push(`M3 S${pwmValue} ; Start spindle (PWM)`);
            } else {
                // Default to fan control (most common for Marlin CNCs)
                lines.push(`M106 S${pwmValue} ; Start fan (spindle analog)`);
            }
            lines.push('G4 P1000 ; Dwell 1 second');
            lines.push('');
            
            // Move to safe position
            const safeZ = options.safeZ || this.config.safetyHeight;
            lines.push(`G0 Z${this.formatCoordinate(safeZ)} ; Move to safe Z`);
            lines.push('G0 X0 Y0 ; Move to origin');
            lines.push('');
            
            return lines.join('\n');
        }
        
        generateFooter(options) {
            const lines = [];
            const safeZ = options.safeZ || this.config.safetyHeight;
            
            lines.push('');
            
            if (options.useM3) {
                lines.push('M5 ; Stop spindle');
            } else {
                lines.push('M107 ; Stop fan');
            }
            
            lines.push(`G0 Z${this.formatCoordinate(safeZ)} ; Retract to safe Z`);
            lines.push('G0 X0 Y0 ; Return to origin');
            lines.push('M84 ; Disable motors');
            lines.push('');
            lines.push('; End of program');
            
            return lines.join('\n');
        }
        
        generateToolChange(tool, options) {
            const lines = [];
            const safeZ = options.safeZ || this.config.safetyHeight;
            
            lines.push('');
            lines.push(`; Tool change: ${tool.name || tool.id}`);
            lines.push(`; Diameter: ${tool.diameter}mm`);
            
            if (options.useM3) {
                lines.push('M5 ; Stop spindle');
            } else {
                lines.push('M107 ; Stop fan');
            }
            
            lines.push(`G0 Z${this.formatCoordinate(safeZ)} ; Retract to safe Z`);
            this.currentPosition.z = safeZ;
            lines.push('M0 ; Pause for manual tool change');
            lines.push('');
            
            const spindleSpeed = tool.spindleSpeed || options.spindleSpeed || 12000;
            const pwmValue = Math.min(255, Math.round((spindleSpeed / 30000) * 255));
            
            if (options.useM3) {
                lines.push(`M3 S${pwmValue} ; Restart spindle`);
            } else {
                lines.push(`M106 S${pwmValue} ; Restart fan`);
            }
            lines.push('G4 P1000 ; Wait for spindle');
            lines.push('');
            
            return lines.join('\n');
        }
    }
    
    window.MarlinPostProcessor = MarlinPostProcessor;
})();
